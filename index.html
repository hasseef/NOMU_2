<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ููุตุฉ ููู NOMU โ v4.1 (ุฅุดุนุงุฑุงุช + SLA + RBAC ููุญููู + ุฑุณูู ุจูุงููุฉ)</title>
<style>
:root{
  --bg:#f7fbff; --paper:#fff; --brand:#16a34a; --ink:#0f172a; --sub:#475569; --accent:#f59e0b;
  --muted:#f1f5f9; --border:#e2e8f0; --radius:16px; --pad:16px; --gap:12px; --gap-lg:20px; --shadow:0 10px 30px rgba(2,12,27,.06);
  --font:"Tajawal","Noto Kufi Arabic",system-ui,-apple-system,"Segoe UI",Arial;
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.7 var(--font)}
a{color:#0ea5e9;text-decoration:none}
header{position:sticky;top:0;z-index:40;background:#ffffffe6;backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
.topbar{max-width:1240px;margin:auto;padding:10px var(--pad);display:flex;align-items:center;gap:10px}
.logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 180deg,#22c55e,#86efac,#34d399,#22c55e);box-shadow:0 6px 16px rgba(16,185,129,.25)}
.left-logos{margin-inline-start:auto;display:flex;gap:8px;align-items:center}
.pill-logo{display:flex;align-items:center;gap:8px;background:var(--muted);border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.pill-logo img{height:28px;display:block}
.rolebox{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.bell{position:relative;cursor:pointer;border:1px solid var(--border);background:#fff;border-radius:12px;padding:8px}
.badge{position:absolute;top:-6px;left:-6px;background:#ef4444;color:#fff;border-radius:999px;font-size:11px;line-height:1;padding:3px 6px}
.npanel{position:absolute;top:54px;inset-inline-end:0;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);width:380px;max-height:60vh;overflow:auto;display:none}
.nitem{padding:10px;border-bottom:1px dashed var(--border)} .nitem:last-child{border-bottom:none}
.main{max-width:1240px;margin:20px auto;display:grid;grid-template-columns:280px 1fr;gap:var(--gap-lg);padding:0 var(--pad)}
nav .side{position:sticky;top:72px;background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
.group h4{margin:10px 8px;color:var(--sub);font-size:13px}
.link{display:flex;gap:10px;padding:10px;border-radius:12px;color:var(--ink);border:1px solid transparent}
.link:hover{background:var(--muted);border-color:var(--border)} .link.active{background:linear-gradient(180deg,#ecfdf5,#e7f9f0);border-color:#befae0}
.content{display:grid;gap:var(--gap-lg)}
.card{background:var(--paper);border:1px solid var(--border);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.tag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#f0fdf4;color:#14532d;padding:6px 10px;border-radius:999px;font-size:12px}
.btn{background:var(--brand);color:#052e1d;border:none;padding:9px 12px;border-radius:12px;font-weight:800;cursor:pointer;box-shadow:0 6px 18px rgba(34,197,94,.25)}
.ghost{background:transparent;border:1px solid var(--border);color:var(--ink)}
.grid{display:grid;gap:var(--gap)} .two{grid-template-columns:1fr 1fr} .three{grid-template-columns:repeat(3,1fr)} .four{grid-template-columns:repeat(4,1fr)}
.form label{display:block;margin:6px 0 4px} .form input,.form select,.form textarea{width:100%;padding:9px;border:1px solid var(--border);border-radius:10px;background:#fff}
.tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:8px}
.tab{padding:8px 12px;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#f8fafc;cursor:pointer}
.tab.active{background:#fff;border-color:#22c55e}
.tabpanel{border:1px solid var(--border);border-radius:0 12px 12px 12px;padding:12px;background:#fff}
.kpi{border:1px solid var(--border);border-radius:14px;padding:14px;background:#f8fffb} .kpi b{display:block;font-size:22px;margin-top:6px}
table{width:100%;border-collapse:separate;border-spacing:0 8px} th,td{text-align:right;padding:10px;background:#fcfdff} th{color:#64748b;font-size:12px}
.tools{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.search{display:flex;gap:8px;align-items:center}
.files{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px} .filepill{display:flex;align-items:center;gap:6px;border:1px dashed #cbd5e1;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
.note{font-size:12px;color:#64748b} .callout{background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:10px}
.warn{color:#b91c1c} .danger{background:#fff1f2;border:1px solid #fecdd3}
canvas{width:100%;height:280px;border:1px solid var(--border);border-radius:12px;background:#fff}
footer{max-width:1240px;margin:22px auto 36px;color:#64748b;text-align:center;padding:0 var(--pad)}
@media (max-width:980px){ .main{grid-template-columns:1fr} .four{grid-template-columns:1fr 1fr} }

.plain-logo{height:32px;display:block;margin-inline-start:8px}

@media (max-width: 979px){
  .topbar .mobile-login-btn{ display:inline-flex; align-items:center; gap:6px; margin-inline-start:8px;
    background:#16a34a; color:#fff; border:none; border-radius:10px; padding:6px 10px; font-size:13px }
  .tabs, .tabbar, .kpi-row{ display:block !important }
  .tabs > *, .tabbar > *{ display:block; margin:6px 0 !important }
  .mobile-cards{ display:grid; gap:10px }
  .brand-title{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52vw }
  .left-logos .plain-logo{ height:22px }
  .bell{ width:40px; height:40px }
  .quick-links{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px }
  .quick-links a{ display:block; text-align:center; border:1px solid var(--border); background:#fff; padding:10px; border-radius:10px }
}

/* ===== Desktop enhancements: login button + grouped sticky menu ===== */
@media (min-width: 980px){
  .desktop-login-btn{
    margin-inline-start:8px; background:#16a34a; color:#fff; border:none;
    border-radius:10px; padding:8px 12px; font-size:13px; cursor:pointer
  }
  /* Sticky grouped menu on the left */
  .layout{ display:grid; grid-template-columns: 280px 1fr; gap:16px; align-items:start }
  .mega-left{ position:sticky; top:72px; align-self:start }
  .mega-left details{ border:1px solid var(--border); background:#fff; border-radius:12px; margin:8px 0; overflow:hidden }
  .mega-left summary{ list-style:none; cursor:pointer; padding:10px 12px; font-weight:700; color:#0f172a }
  .mega-left summary::-webkit-details-marker{ display:none }
  .mega-left .group-body{ padding:8px 10px; display:grid; gap:6px }
  .mega-left a{ display:block; padding:8px 10px; border-radius:10px; color:#334155; text-decoration:none }
  .mega-left a:hover{ background:#f1f5f9 }
  /* Hide old long side nav when grouped menu is present */
  nav.side{ display:none !important }
  /* Content area spacing */
  .content-area{ min-height:60vh }
}
</style>
</head>
<body>
<header>
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <div class="logo" aria-hidden="true"></div>
      <div><b>NOMU โ ููุตุฉ ููู</b><div style="font-size:12px;color:#0f766e">ููุตุฉ ูุทููุฉ ููุทูููุฉ ุงููุจูุฑุฉ</div></div>
    </div>

    <div class="left-logos">
  <img class="plain-logo" src="vision2030.png" alt="">
  <img class="plain-logo" src="talbiya.png" alt="">

      <img class="plain-logo" src=".png" alt="">
      <img class="plain-logo" src=".png" alt="">

      <!-- ุดุนุงุฑุง  +  (SVG Data URI ุชุนูู ูุจุงุดุฑุฉ) -->
      <!-- ุงุฎุชูุงุฑ ุงูุฏูุฑ ุงูุญุงูู + ุฌุฑุณ ุงูุฅุดุนุงุฑุงุช -->
      <div class="rolebox">
        <span>ุงูุฏูุฑ:</span>
        <select id="currentRole">
          <option>clinic.staff</option>
          <option>health.practitioner</option>
          <option>education.specialist</option>
          <option>neighborhood.coordinator</option>
          <option>nonprofit.worker</option>
          <option>admin.national</option>
          <option>family.guardian</option>
        </select>
      </div>
<button class="desktop-login-btn" id="desktopLoginBtn" aria-label="ุชุณุฌูู ุงูุฏุฎูู (ููุจููุชุฑ)">ุชุณุฌูู ุงูุฏุฎูู</button>
      <div style="position:relative">
        <button id="bell" class="bell">๐<span id="bellBadge" class="badge" style="display:none">0</span></button>
        <div id="npanel" class="npanel"></div>
      </div>
    </div>
  </div>
</header>


<div class="layout">
  <aside class="mega-left">
    <details open>
      <summary>ุงูุจุฏุก ุงูุณุฑูุน</summary>
      <div class="group-body">
        <a href="#/overview">ูุธุฑุฉ ุนุงูุฉ</a>
        <a href="#/intro">ุงูุชุนุฑูู ุจุงูููุตุฉ</a>
      </div>
    </details>
    <details>
      <summary>ุงูุญุณุงุจุงุช</summary>
      <div class="group-body">
        <a href="#/acc/health">ูุฒุงุฑุฉ ุงูุตุญุฉ</a>
        <a href="#/acc/clinic">ุงููุฑุงูุฒ ุงูุตุญูุฉ</a>
        <a href="#/acc/education">ูุฒุงุฑุฉ ุงูุชุนููู</a>
        <a href="#/acc/neighborhood">ูุฑุงูุฒ ุงูุฃุญูุงุก</a>
        <a href="#/acc/nonprofit">ุงูุฌูุนูุงุช</a>
        <a href="#/acc/hr">ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</a>
        <a href="#/acc/csr">ุงููุทุงุน ุงูุฎุงุต</a>
        <a href="#/acc/family">ุงูุฃุณุฑุฉ</a>
        <a href="#/acc/admin">ุงููุฌูุฉ ุงููุทููุฉ</a>
      </div>
    </details>
    <details>
      <summary>ุงูุชุดุบูู ูุงูุชูุงุฑูุฑ</summary>
      <div class="group-body">
        <a href="#/operations">ุงูุชุดุบูู</a>
        <a href="#/reports">ุงูุชูุงุฑูุฑ</a>
        <a href="#/kpi">ูุคุดุฑุงุช KPI</a>
      </div>
    </details>
    <details>
      <summary>ุงูุฏุนู ูุงูุฌูุฏุฉ</summary>
      <div class="group-body">
        <a href="#/support">ุงูุฏุนู ุงูููู</a>
        <a href="#/policies">ุงูุฃุฏูุฉ ูุงูุณูุงุณุงุช</a>
        <a href="#/contact">ุชูุงุตู ูุนูุง</a>
      </div>
    </details>
  </aside>
  <section id="contentArea" class="content-area">
<main class="main">
  <nav>
    <div class="side">
      <div class="group">
        <h4>ุงูุชุนุงุฑูู</h4>
        <a class="link" href="#/intro">ุนู ุงูููุตุฉ</a>
        <a class="link" href="#/kpi">ุณุฌู KPI + ุฑุณูู</a>
      </div>
      <div class="group">
        <h4>ุงูุญุณุงุจุงุช</h4>
        <a class="link" href="#/acc/health">ูุฒุงุฑุฉ ุงูุตุญุฉ</a>
        <a class="link" href="#/acc/clinic">ุงููุฑุงูุฒ ุงูุตุญูุฉ</a>
        <a class="link" href="#/acc/education">ูุฒุงุฑุฉ ุงูุชุนููู</a>
        <a class="link" href="#/acc/neighborhood">ูุฑุงูุฒ ุงูุฃุญูุงุก</a>
        <a class="link" href="#/acc/nonprofit">ุงูุฌูุนูุงุช</a>
        <a class="link" href="#/acc/hr">ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ</a>
        <a class="link" href="#/acc/csr">ุงููุทุงุน ุงูุฎุงุต</a>
        <a class="link" href="#/acc/family">ุงูุฃุณุฑุฉ</a>
        <a class="link" href="#/acc/admin">ุงููุฌูุฉ ุงููุทููุฉ</a>
      </div>
      <div class="group">
        <h4>ุชุดุบูู</h4>
        <a class="link" href="#/dispatch">ููุฒูุน ุงูููุงุนูุฏ</a>
        <a class="link" href="#/ops">ููุญุฉ ุงููุฑุงูุฒ</a>
      </div>
      <div class="group">
        <h4>ุงูุงุณุชุฏุงูุฉ</h4>
        <a class="link" href="#/sponsors">ุจูุงุจุฉ ุงูุฑุนุงุฉ</a>
        <a class="link" href="#/pricing">ููุงุฆุญ ุงูุฃุณุนุงุฑ</a>
      </div>
      <div class="group">
        <h4>ุงูุฃูู ูุงูุฑุจุท</h4>
        <a class="link" href="#/sso">SSO ููุงุฐ</a>
        <a class="link" href="#/rbac">RBAC</a>
        <a class="link" href="#/config">ุงูุฅุนุฏุงุฏุงุช</a>
      </div>
      <div class="group">
        <h4>ุณูุงุณุงุช ููุณุงุนุฏุฉ</h4>
        <a class="link" href="#/privacy">ุงูุฎุตูุตูุฉ</a>
        <a class="link" href="#/child">ุญูุงูุฉ ุงูุทูู</a>
        <a class="link" href="#/terms">ุงูุดุฑูุท ูุงูุฃุญูุงู</a>
      </div>
      <div class="group">
        <h4>ุฃุฏูุงุช</h4>
        <a class="link" href="#/export">ุชุตุฏูุฑ</a>
        <a class="link" href="#/apidocs">API Docs</a>
      </div>
    </div>
  </nav>
  <section class="content" id="view"></section>
</section></div>
</main>

<footer>ููู NOMU โ v4.1 (ุฅุดุนุงุฑุงุช + SLA + RBAC ููุญููู + ุฑุณูู ุจูุงููุฉ + CRUD ูุงูู ูุญูุธ ูุญูู)</footer>

<script>
/* ===== ุฃุฏูุงุช ุนุงูุฉ ===== */
const $=(q,root=document)=>root.querySelector(q);
const $$=(q,root=document)=>Array.from(root.querySelectorAll(q));
const uid=(p='ID')=>p+'-'+Math.random().toString(36).slice(2,8).toUpperCase();
const today=()=>new Date().toISOString().slice(0,10);
function route(){ const p=location.hash.slice(1)||'/intro'; $$('a.link').forEach(a=>a.classList.toggle('active', a.getAttribute('href')===`#${p}`)); (routes[p]||intro)(); }
window.addEventListener('hashchange',route);
const downloadFile=(name,blob)=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); };
const downloadJSON=(name,obj)=>downloadFile(name,new Blob([JSON.stringify(obj,null,2)],{type:'application/json'}));
const toCSV=(rows)=>rows.map(r=>r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(',')).join('\n');
const downloadCSV=(name,rows)=>downloadFile(name,new Blob([toCSV(rows)],{type:'text/csv'}));

/* ===== Config / RBAC / ุงูุฏูุฑ ุงูุญุงูู ===== */
const DEFAULT_CONFIG={ sso:{ issuer:'https://nafath.example.gov.sa', authorize_url:'https://nafath.example.gov.sa/authorize', token_url:'https://nafath.example.gov.sa/token', client_id:'NOMU-CLIENT-ID', redirect_uri:'https://nomu.gov.sa/callback' }, apis:{ internal:{ health:'/api/health', clinic:'/api/clinic', education:'/api/education', neighborhood:'/api/neighborhood', nonprofit:'/api/nonprofit', hr:'/api/hr', csr:'/api/csr', family:'/api/family', admin:'/api/admin', dispatch:'/api/dispatch' } } };
const loadCfg=()=>{ try{ return JSON.parse(localStorage.getItem('nomu_cfg')||'null') || DEFAULT_CONFIG }catch(e){ return DEFAULT_CONFIG } };
const saveCfg=(cfg)=>localStorage.setItem('nomu_cfg', JSON.stringify(cfg));
let RBAC={ roles:{
  'health.practitioner':['child.read','health.write','referral.send','referral.accept','appointment.manage','kpi.view'],
  'clinic.staff':['child.read','appointment.manage','referral.accept','kpi.view'],
  'education.specialist':['child.read','education.write','referral.accept','kpi.view'],
  'neighborhood.coordinator':['program.manage','booking.manage','referral.accept','kpi.view'],
  'nonprofit.worker':['child.read','service.write','referral.accept','kpi.view'],
  'admin.national':['kpi.view','kpi.define','policy.write','audit.read'],
  'family.guardian':['child.own','consent.grant','appointment.book']
}};
const can=(role,perm,consent=true)=> (RBAC.roles[role]||[]).includes(perm) && (perm!=='child.read' || consent || role==='admin.national');
const ROLE_KEY='nomu_role';
const loadRole=()=>localStorage.getItem(ROLE_KEY)||'clinic.staff';
const saveRole=(r)=>localStorage.setItem(ROLE_KEY,r);
$('#currentRole').value=loadRole();
$('#currentRole').onchange=(e)=>{ saveRole(e.target.value); document.dispatchEvent(new CustomEvent('role-change',{detail:e.target.value})); };

/* ===== DB ูุญูู + API ูุญุงูู ===== */
const DB_KEY='nomu_db_v41';
const DB=()=>{ try{ return JSON.parse(localStorage.getItem(DB_KEY)||'{}') }catch(e){ return {} } };
const DB_SAVE=(db)=>localStorage.setItem(DB_KEY, JSON.stringify(db));
const ensure=(...path)=>{ const db=DB(); let cur=db; for(const k of path){ cur[k]=cur[k]||{}; cur=cur[k]; } DB_SAVE(db); return cur; };
const API={
  list:(entity,section)=>Object.values(ensure(entity,section).items||{}),
  create:(entity,section,record)=>{ const root=ensure(entity,section); root.items=root.items||{}; const id=uid('REC'); root.items[id]={id,...record,createdAt:new Date().toISOString()}; DB_SAVE(DB()); return root.items[id]; },
  update:(entity,section,id,patch)=>{ const root=ensure(entity,section); if(root.items?.[id]){ root.items[id]={...root.items[id],...patch,updatedAt:new Date().toISOString()}; DB_SAVE(DB()); return root.items[id]; } },
  remove:(entity,section,id)=>{ const root=ensure(entity,section); if(root.items?.[id]){ delete root.items[id]; DB_SAVE(DB()); return true; } return false; },
  import:(entity,section,arr)=>{ const root=ensure(entity,section); root.items=root.items||{}; arr.forEach(x=>{ const id=x.id||uid('REC'); root.items[id]={id,...x}; }); DB_SAVE(DB()); },
  clear:(entity,section)=>{ const root=ensure(entity,section); root.items={}; DB_SAVE(DB()); },
};

/* ===== ุฅุดุนุงุฑุงุช + ุชุฐููุฑ SLA ===== */
const NOTIF_KEY='nomu_notif';
const loadNotif=()=>{ try{ return JSON.parse(localStorage.getItem(NOTIF_KEY)||'[]') }catch(e){ return [] } };
const saveNotif=(arr)=>localStorage.setItem(NOTIF_KEY, JSON.stringify(arr));
function pushNotif({title,body,type='info',link=null}){
  const list=loadNotif(); list.unshift({id:uid('NTF'),ts:new Date().toISOString(),title,body,type,link,read:false}); saveNotif(list); renderBell();
}
function renderBell(){
  const list=loadNotif(); const unread=list.filter(n=>!n.read).length; const badge=$('#bellBadge'); badge.textContent=unread; badge.style.display=unread? 'inline-block':'none';
  const panel=$('#npanel'); panel.innerHTML=list.length? list.map(n=>`<div class="nitem">
    <div><b>${n.title}</b> โข <span class="note">${new Date(n.ts).toLocaleString('ar-SA')}</span></div>
    <div>${n.body}</div>${n.link?`<div class="note"><a href="${n.link}">ูุชุญ</a></div>`:''}
  </div>`).join('') : `<div class="nitem note">ูุง ุฅุดุนุงุฑุงุช</div>`;
}
$('#bell').onclick=()=>{ const p=$('#npanel'); const show=p.style.display!=='block'; p.style.display=show?'block':'none'; if(show){ const list=loadNotif().map(n=>({...n,read:true})); saveNotif(list); renderBell(); } };
document.addEventListener('role-change',renderBell);
renderBell();

/* ===== ูุฑุงูุจุฉ SLA ููุฅุญุงูุงุช (ูู ุชุญููู/ูู ุฏูููุฉ) ===== */
function scanSLA(){
  const entities=['health','education','clinic','nonprofit','neighborhood'];
  const now=Date.now();
  entities.forEach(ent=>{
    const refs=API.list(ent,'ุงูุฅุญุงูุงุช');
    refs.forEach(r=>{
      const opened=r.opened_at? new Date(r.opened_at).getTime():null; const sla=parseInt(r.sla||'7',10);
      if(opened){ const days=Math.ceil((now-opened)/86400000); if(days>sla && !r._slaNotified){
        pushNotif({title:'ุชุฌุงูุฒ SLA', body:`ุฅุญุงูุฉ ูุชุฃุฎุฑุฉ ูุฏู ยซ${ent}ยป: ${days}/${sla} ููู.`, type:'warn', link:'#/acc/'+ent});
        // ุถุน ุนูุงูุฉ ูู ูุง ุชุชูุฑุฑ
        API.update(ent,'ุงูุฅุญุงูุงุช',r.id,{_slaNotified:true});
      }}
    });
  });
}
scanSLA(); setInterval(scanSLA, 60000);

/* ===== ุชุดุบูู ุงููุฑุงูุฒ + ุชูุฒูุน ===== */
const CENTERS=[
  { id:'CLN-001', name:'ูุฑูุฒ ุตุญู ุญู ุงูุงุฒุฏูุงุฑ', type:'clinic', region:'ุงูุฑูุงุถ', specialty:['ููุงุฆู','ุชุฎุงุทุจ'], capacityDay:24, bookedToday:8, avgVisitMin:30, slaDays:7 },
  { id:'CLN-002', name:'ูุฑูุฒ ุตุญู ุญู ุงูุดุงุทุฆ', type:'clinic', region:'ุงูุดุฑููุฉ', specialty:['ููุงุฆู','ูุธููู'], capacityDay:18, bookedToday:15, avgVisitMin:40, slaDays:5 },
  { id:'NHB-101', name:'ูุฑูุฒ ุญู ุงูุชุนุงูู', type:'neighborhood', region:'ุงูุฑูุงุถ', specialty:['ุชูุนูุฉ','ูุฑุฒ ุฃููู'], capacityDay:40, bookedToday:10, avgVisitMin:20, slaDays:3 },
  { id:'NHB-102', name:'ูุฑูุฒ ุญู ุงูุนููุง', type:'neighborhood', region:'ุงูุฑูุงุถ', specialty:['ุชูุนูุฉ','ูุฑุฒ ุฃููู'], capacityDay:35, bookedToday:34, avgVisitMin:20, slaDays:3 },
  { id:'NGO-501', name:'ุฌูุนูุฉ ููุงุก ุงูุทูููุฉ', type:'nonprofit', region:'ุงูุฑูุงุถ', specialty:['ุชุฏุฎู ูุจูุฑ','ุชุฎุงุทุจ'], capacityDay:22, bookedToday:6, avgVisitMin:45, slaDays:10 }
];
const occPct=c=>Math.round((c.bookedToday / Math.max(1,c.capacityDay))*100);
const estWaitDays=c=>{ const overflow=Math.max(0, c.bookedToday - c.capacityDay); return overflow>0 ? Math.ceil(overflow / Math.max(1,c.capacityDay)) : 0; };
function pickCenter({region, need, maxSlaDays=14}){
  const candidates = CENTERS.filter(c=> (c.region===region) && (need==='ูุฑุฒ ุฃููู' ? true : c.specialty.includes(need)));
  if(!candidates.length) return null;
  const scored = candidates.map(c=>{
    const occ = c.bookedToday/Math.max(1,c.capacityDay), occScore=1-Math.min(1,occ);
    const slaScore=Math.max(0,(maxSlaDays-c.slaDays)/maxSlaDays);
    return {c,score:occScore*0.6+slaScore*0.4};
  }).sort((a,b)=>b.score-a.score);
  return scored[0]?.c||null;
}

/* ===== KPI ===== */
const KPI_REGISTRY=[
  { id:'DEV_SCREEN', name:'ูุณุจุฉ ุชุบุทูุฉ ุงููุญุต ุงูููุงุฆู', owner:'ูุฒุงุฑุฉ ุงูุตุญุฉ', formula:'ุงูููุญูุตูู รท ุงููุณุชูุฏููู ร100', period:'ุดูุฑู', source:'HealthAssessment' },
  { id:'SCHOOL_READY', name:'ูุณุจุฉ ุงูุฌุงูุฒูุฉ ุงููุฏุฑุณูุฉ', owner:'ูุฒุงุฑุฉ ุงูุชุนููู', formula:'ุฌุงูุฒูู รท ุฅุฌูุงูู 5โ6 ร100', period:'ูุตูู', source:'EducationPlan' },
  { id:'REF_TTR', name:'ุฒูู ุงูุฅุญุงูุฉ (ููู)', owner:'ุงููุฌูุฉ ุงููุทููุฉ', formula:'ูุชูุณุท (ูุจูู โ ูุชุญ)', period:'ุดูุฑู', source:'Referral' },
  { id:'WAIT', name:'ูุชูุณุท ุงูุชุธุงุฑ ุงูุฎุฏูุฉ', owner:'ุงูุฌูุฉ ุงูููุฏูููุฉ', formula:'ูุชูุณุท (ุฃูู ุฌูุณุฉ โ ุงููุจูู)', period:'ุดูุฑู', source:'ServiceSession' },
  { id:'CSR_FUNDS', name:'ุชูููู CSR', owner:'ุงููุทุงุน ุงูุฎุงุต + ุงูููุตุฉ', formula:'ุงูุชุนูุฏุงุช ุงููุคูุฏุฉ + ุงููุญููู', period:'ุฑุจุน ุณููู', source:'CSRCommitment' },
  { id:'ACTIVE_REF', name:'ุงูุฅุญุงูุงุช ุงููุดุทุฉ', owner:'ุงููุฌูุฉ ุงููุทููุฉ', formula:'ุงูููุชูุญุฉ โ ุงููุบููุฉ', period:'ูููู', source:'Referral' }
];

/* ===== ููููุฏ ููุงุฐุฌ/ุฌุฏุงูู + RBAC ุญููู ===== */
function buildForm(container, schema, current=null){
  const role=loadRole();
  container.innerHTML = `<div class="form grid two">
    ${schema.map(f=>{
      const val=current?.[f.key]??(f.value??'');
      const type=f.type||'text';
      const dis = f.perm && !can(role,f.perm) ? 'disabled' : '';
      const extra=(type==='textarea')?`<textarea ${dis} data-key="${f.key}" placeholder="${f.key}">${val}</textarea>`:`<input ${dis} type="${type}" data-key="${f.key}" value="${val}" placeholder="${f.key}"/>`;
      return `<label>${f.label}${f.perm?` <span class="note">(${f.perm})</span>`:''}${extra}</label>`;
    }).join('')}
    ${schema.some(f=>f.type==='file')?`<div class="files" id="flist"></div>`:''}
  </div>`;
  // ูุฑููุงุช
  schema.filter(f=>f.type==='file').forEach(f=>{
    const input = container.querySelector(`[data-key="${f.key}"]`);
    const flist = container.querySelector('#flist');
    input?.addEventListener('change', e=>{
      [...e.target.files].forEach(file=>{
        const url=URL.createObjectURL(file);
        const pill=document.createElement('span'); pill.className='filepill';
        pill.innerHTML=`๐ ${file.name} โข ${(file.size/1024).toFixed(1)} KB <a href="${url}" download="${file.name}">ุชูุฒูู</a>`;
        flist.appendChild(pill);
      });
    });
  });
}
function buildTable(container, schema, rows, {onEdit,onDelete}={}){
  if(!rows.length){ container.innerHTML='<div class="note">ูุง ุชูุฌุฏ ุณุฌูุงุช.</div>'; return; }
  const cols = ['id',...schema.map(f=>f.key),'createdAt','updatedAt'];
  container.innerHTML = `
    <div class="tools">
      <div class="search">
        <input id="q" placeholder="ุจุญุซ ุณุฑูุน" />
        <button class="ghost" id="exportCsv">ุชุตุฏูุฑ CSV</button>
        <label class="ghost" style="padding:6px 10px;border-radius:10px;cursor:pointer">
          ุงุณุชูุฑุงุฏ JSON <input id="importJson" type="file" accept="application/json" style="display:none"/>
        </label>
      </div>
    </div>
    <div style="overflow:auto"><table id="tbl"><thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}<th>ุฅุฌุฑุงุกุงุช</th></tr></thead><tbody></tbody></table></div>`;
  const tbody=$('#tbl tbody',container);
  const render=(data)=>{ tbody.innerHTML=data.map(r=>`<tr>${cols.map(c=>`<td>${(r[c]??'')}</td>`).join('')}<td>
      <button class="ghost" data-edit="${r.id}">ุชุนุฏูู</button>
      <button class="ghost" data-del="${r.id}">ุญุฐู</button>
    </td></tr>`).join(''); };
  render(rows);
  $('#q',container).oninput=(e)=>{ const q=e.target.value.trim(); const filtered=rows.filter(r=>JSON.stringify(r).includes(q)); render(filtered); };
  $('#exportCsv',container).onclick=()=>{ const header=[...cols]; const data=rows.map(r=>cols.map(c=>r[c]??'')); downloadCSV('export.csv',[header,...data]); };
  $('#importJson',container).onchange=(e)=>{ const file=e.target.files[0]; if(!file) return; const fr=new FileReader(); fr.onload=()=>{ try{ const arr=JSON.parse(fr.result||'[]'); onEdit?.({import:arr}); }catch(err){ alert('JSON ุบูุฑ ุตุญูุญ'); } }; fr.readAsText(file); };
  container.addEventListener('click',(ev)=>{
    const id=ev.target.getAttribute('data-edit'); const del=ev.target.getAttribute('data-del');
    if(id && onEdit) onEdit({id});
    if(del && onDelete) onDelete({id:del});
  });
}

/* ===== ุงูุฑุณูู ุงูุจูุงููุฉ (Canvas Vanilla) ===== */
function drawBarChart(canvas, labels, values){
  const ctx=canvas.getContext('2d'); const w=canvas.width=canvas.clientWidth*2, h=canvas.height=canvas.clientHeight*2; ctx.scale(2,2);
  const max=Math.max(1,...values), pad=24, bw=(canvas.clientWidth - pad*2)/values.length*0.7, gap=(canvas.clientWidth - pad*2)/values.length*0.3;
  ctx.clearRect(0,0,canvas.clientWidth,canvas.clientHeight);
  ctx.fillStyle='#0f172a'; ctx.font='12px Tajawal';
  // axes
  ctx.strokeStyle='#e2e8f0'; ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, canvas.clientHeight-pad); ctx.lineTo(canvas.clientWidth-pad, canvas.clientHeight-pad); ctx.stroke();
  // bars
  values.forEach((v,i)=>{
    const x=pad + i*(bw+gap) + gap*0.5; const bh=(canvas.clientHeight-pad*2)*(v/max);
    ctx.fillStyle='#16a34a'; ctx.fillRect(x, canvas.clientHeight-pad-bh, bw, bh);
    ctx.fillStyle='#475569'; ctx.fillText(labels[i], x, canvas.clientHeight-pad+14);
    ctx.fillStyle='#0f172a'; ctx.fillText(v.toString(), x+bw/3, canvas.clientHeight-pad-bh-6);
  });
}

/* ===== ุชุนุฑูู ุงูุญููู/ุงูุชุจููุจุงุช ูุน RBAC ููุญููู ===== */
const ACCOUNTS={
  health:{ title:'ูุฒุงุฑุฉ ุงูุตุญุฉ', tabs:{
    'ุณุฌู ุงููุญูุต':[
      {label:'MRN',key:'mrn',perm:'health.write'},{label:'ูุชูุฌุฉ ุงููุญุต ุงูููุงุฆู',key:'dev_result',perm:'health.write'},
      {label:'PHQ-2/9',key:'phq_score',perm:'health.write'},{label:'ICD-10',key:'icd10',perm:'health.write'}
    ],
    'ุงูุชุฏุฎู ุงููุจูุฑ':[
      {label:'ููุน ุงูุชุฏุฎู',key:'intervention_type',perm:'health.write'},{label:'ุนุฏุฏ ุงูุฌูุณุงุช',key:'sessions',type:'number',perm:'health.write'},
      {label:'ููุนุฏ ุงููุชุงุจุนุฉ',key:'followup_date',type:'date',perm:'health.write'}
    ],
    'ุงูุฅุญุงูุงุช':[
      {label:'ุชุงุฑูุฎ ูุชุญ ุงูุญุงูุฉ',key:'opened_at',type:'date',value:today(),perm:'referral.send'},
      {label:'ุฌูุฉ ุงูุฅุญุงูุฉ',key:'ref_to',perm:'referral.send'},{label:'ุฃููููุฉ',key:'priority',perm:'referral.send'},
      {label:'SLA (ููู)',key:'sla',type:'number',value:7,perm:'referral.send'}
    ],
    'ุงูููุงุนูุฏ':[
      {label:'ูููุฉ ุงูุทูู',key:'childId',perm:'appointment.manage'},{label:'ุงูููุทูุฉ',key:'region',perm:'appointment.manage'},
      {label:'ุงูุญุงุฌุฉ',key:'need',perm:'appointment.manage'},{label:'ุฃููููุฉ',key:'prio',perm:'appointment.manage'}
    ],
    'ูุทุงูุจุงุช NPHIES':[ {label:'ุฑูู ุงููุทุงูุจุฉ',key:'claim_id'},{label:'ุงูุญุงูุฉ',key:'claim_status'} ],
    'ุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
  clinic:{ title:'ุงููุฑุงูุฒ ุงูุตุญูุฉ', tabs:{
    'ุงูููุงุนูุฏ':[ {label:'ุณุฌู ุงูุทูู',key:'mrn',perm:'appointment.manage'},{label:'ุงูุชุฎุตุต',key:'specialty',perm:'appointment.manage'},{label:'ููุนุฏ',key:'appt_datetime',type:'datetime-local',perm:'appointment.manage'} ],
    'ุงูุฅุญุงูุงุช':[ {label:'ูู ุฌูุฉ',key:'ref_from'},{label:'ุญุงูุฉ ุงูุฅุญุงูุฉ',key:'ref_status'},{label:'ุชุงุฑูุฎ ุงููุจูู',key:'accepted_at',type:'date'} ],
    'ุงูุฎุฏูุงุช':[ {label:'ุงุณู ุงูุฎุฏูุฉ',key:'service'},{label:'SLA ุฃูุงู',key:'sla_days',type:'number'} ],
    'ุงููุฎุฒูู':[ {label:'ูุนุฏุงุช/ุฃุฏูุงุช',key:'inventory_item'},{label:'ุงููููุฉ',key:'qty',type:'number'} ],
    'ุงูุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
  education:{ title:'ูุฒุงุฑุฉ ุงูุชุนููู', tabs:{
    'ุฌุงูุฒูุฉ ุงููุฏุฑุณุฉ':[ {label:'ุฏุฑุฌุฉ ุงูุฌุงูุฒูุฉ',key:'readiness_score',type:'number',perm:'education.write'},{label:'ุงููุฏุฑุณุฉ',key:'school_name',perm:'education.write'} ],
    'IEP/ุฏูุฌ':[ {label:'IEP JSON',key:'iep_json',type:'textarea',perm:'education.write'},{label:'ููุน ุงูุฏูุฌ',key:'inclusion_type',perm:'education.write'} ],
    'ุงูุฅุญุงูุงุช':[ {label:'ุชุงุฑูุฎ ูุชุญ',key:'opened_at',type:'date',value:today(),perm:'referral.send'},{label:'ุฅูู ุฌูุฉ',key:'ref_to',perm:'referral.send'},{label:'SLA (ููู)',key:'sla',type:'number',value:10,perm:'referral.send'} ],
    'ุชูุงุตู ุงูุฃุณุฑุฉ':[ {label:'ูููุฉ ููู ุงูุฃูุฑ',key:'guardian_id'},{label:'ุงูููุงุฉ',key:'channel'} ],
    'ุชูุงุฑูุฑ ููุฑ':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
  neighborhood:{ title:'ูุฑุงูุฒ ุงูุฃุญูุงุก', tabs:{
    'ุงูุจุฑุงูุฌ':[ {label:'ุงุณู ุงูุจุฑูุงูุฌ',key:'program'},{label:'ุงููุฆุฉ ุงูุนูุฑูุฉ',key:'age_band'},{label:'ุงูุทุงูุฉ ุงูุงุณุชูุนุงุจูุฉ',key:'capacity',type:'number'} ],
    'ุงููุชุทูุนูู':[ {label:'ุงุณู ุงููุชุทูุน',key:'vol_name'},{label:'ุณุงุนุงุช ุงูุชุทูุน',key:'vol_hours',type:'number'} ],
    'ุงูุญุฌูุฒุงุช':[ {label:'ุชุงุฑูุฎ',key:'date',type:'date'},{label:'ุนุฏุฏ ุงูููุงุนุฏ',key:'seats',type:'number'} ],
    'ุงูุฅุญุงูุงุช':[ {label:'ูู/ุฅูู',key:'ref_direction'},{label:'ุงูุญุงูุฉ',key:'status'} ],
    'ุงูุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
  nonprofit:{ title:'ุงูุฌูุนูุงุช', tabs:{
    'ุงูุจุฑุงูุฌ':[ {label:'ุงุณู ุงูุจุฑูุงูุฌ',key:'program'},{label:'ุนุฏุฏ ุงูุฌูุณุงุช',key:'sessions',type:'number'} ],
    'ุงููุณุชููุฏูู':[ {label:'ูููุฉ ููู ุงูุฃูุฑ',key:'guardian_id'},{label:'ุงูููุทูุฉ',key:'region'} ],
    'ุงููุชุทูุนูู':[ {label:'ุงุณู ุงููุชุทูุน',key:'vol_name'},{label:'ุณุงุนุงุช ุงูุชุทูุน',key:'hours',type:'number'} ],
    'ุงูุฅุญุงูุงุช':[ {label:'ุฅูู ุฌูุฉ',key:'ref_to'},{label:'ุงูุญุงูุฉ',key:'status'} ],
    'ููุงุณ ุงูุฃุซุฑ':[ {label:'ุชุญุณู ุงูุทูู (%)',key:'improve_pct',type:'number'} ],
    'ุงูุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
  hr:{ title:'ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ', tabs:{
    'ูุญูุธุฉ ุงูุฏุนู':[ {label:'ููุน ุงูุฏุนู',key:'support_type'},{label:'ุงููุจูุบ/ุงูุดูุฑ',key:'amount',type:'number'},{label:'ุฃูููุฉ ุงูุฃุณุฑุฉ',key:'eligibility'} ],
    'ุงูุชุทูุน ุงููุทูู':[ {label:'ุงููุจุงุฏุฑุฉ',key:'initiative'},{label:'ุงูุณุงุนุงุช',key:'hours',type:'number'} ],
    'ุงูุชูุงุฑูุฑ':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
  csr:{ title:'ุงููุทุงุน ุงูุฎุงุต', tabs:{
    'ุณูู ุงูุฑุนุงูุฉ':[ {label:'ุงุณู ุงูุดุฑูุฉ',key:'company'},{label:'ุงููุฆุฉ',key:'tier'},{label:'ุงูููุทูุฉ',key:'region'} ],
    'ุชุนูุฏุงุช ุงูุดุฑูุฉ':[ {label:'ูููุฉ ุงูุชุนูุฏ',key:'amount',type:'number'},{label:'ุงูุบุฑุถ',key:'purpose'} ],
    'ุชูุงุฑูุฑ ุงูุฃุซุฑ':[], 'ุญูููุฉ CSR':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
  family:{ title:'ุงูุฃุณุฑุฉ', tabs:{
    'ููู ุงูุญูู ูุงูุทูู':[ {label:'ูููุฉ ููู ุงูุฃูุฑ',key:'guardian_id'},{label:'ุงูููุทูุฉ',key:'region'},{label:'ููุงููุฉ ูุดุงุฑูุฉ ุงูุจูุงูุงุช',key:'consent'} ],
    'ุงูููุงุนูุฏ':[ {label:'ุงูุฎุฏูุฉ',key:'service'},{label:'ููุนุฏ',key:'date',type:'date'} ],
    'ุงูุชูุตูุงุช':[], 'ุงูุฎุฏูุงุช ุงููุณุงูุฏุฉ':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
  admin:{ title:'ุงููุฌูุฉ ุงููุทููุฉ', tabs:{
    'ููุญุฉ ูุทููุฉ':[],
    'ุญูููุฉ ุงูุจูุงูุงุช':[ {label:'ูุฑุงุฑ ุณูุงุณุฉ',key:'policy_decision',perm:'policy.write'} ],
    'ุงูุชูุงููุงุช':[ {label:'ุชุนุฑูู KPI',key:'kpi_def',perm:'kpi.define'} ],
    'ุงูุฅุดุฑุงู ุนูู ุงูุฅุญุงูุงุช':[ {label:'SLA ุงูุชุฑุงุถู (ููู)',key:'sla_default',type:'number',value:7,perm:'policy.write'} ],
    'ุงูุชูุงุฑูุฑ ุงููุทููุฉ':[], 'ูุฑููุงุช':[ {label:'ูููุงุช',key:'files',type:'file'} ]
  }},
};

/* ===== ุตูุญุงุช ุงููุญุชูู ===== */
function intro(){
  const v=$('#view');
  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>ุนู ููุตุฉ ููู (NOMU)</h2>
<div class="quick-links" id="quickLinksMobile">
  <a href="#/overview">ูุธุฑุฉ ุนุงูุฉ</a>
  <a href="#/reports">ุงูุชูุงุฑูุฑ</a>
  <a href="#/support">ุงูุฏุนู ุงูููู</a>
  <a href="#/policies">ุงูุฃุฏูุฉ ูุงูุณูุงุณุงุช</a>
  <a href="#/contact">ุงุชุตู ุจูุง</a>
  <a href="#/about">ูู ูุญู</a>
</div>
<span class="tag">ููุตุฉ ูุทููุฉ ููุทูููุฉ ุงููุจูุฑุฉ</span></div>
    <p><b>ุงูุฑุคูุฉ:</b> ุชูููู ูู ุทูู ูู ุงูููููุฉ ูู ุจุฏุงูุฉ ูููุฉ ูุชูุงููุฉ ุตุญููุง ูุชุนูููููุง ูุงุฌุชูุงุนููุง.<br/>
       <b>ุงูุฑุณุงูุฉ:</b> ููุตุฉ ููุญุฏุฉ ูุฑุญูุฉ ุงูุทูู ูุงูุฃุณุฑุฉ ุนุจุฑ ุงูุชูุงููุ ุงูุฅุญุงูุงุชุ ุงููุคุดุฑุงุชุ ูุงูุงุณุชุฏุงูุฉ.</p>
    <div class="grid four">
      <div class="kpi"><div>ุชุบุทูุฉ ุงููุญุต ุงูููุงุฆู</div><b id="k1">โ%</b><span class="note">ูุฏู 2025: 80%</span></div>
      <div class="kpi"><div>ุงูุฌุงูุฒูุฉ ุงููุฏุฑุณูุฉ</div><b id="k2">โ%</b><span class="note">ูุฏู 2025: 75%</span></div>
      <div class="kpi"><div>ูุชูุณุท ุฒูู ุงูุฅุญุงูุฉ</div><b id="k3">โ ููู</b><span class="note">โค 7</span></div>
      <div class="kpi"><div>ุชูููู CSR</div><b id="k4">โ ุฑ.ุณ</b><span class="note">ุณููู</span></div>
    </div>
  </div>`;
}
function kpiPage(){
  const v=$('#view');
  // ุฅุญุตุงุกุงุช ุจุณูุทุฉ ูู ุงูุณุฌูุงุช ุงููุฏุฎูุฉ
  const dev = API.list('health','ุณุฌู ุงููุญูุต');
  const ready = API.list('education','ุฌุงูุฒูุฉ ุงููุฏุฑุณุฉ');
  const referrals = ['health','education','clinic','nonprofit','neighborhood'].flatMap(e=>API.list(e,'ุงูุฅุญุงูุงุช'));
  const coverage = dev.length? Math.round((dev.filter(d=>String(d.dev_result||'').trim()).length / dev.length)*100):0;
  const readiness = ready.length? Math.round(ready.map(r=>parseInt(r.readiness_score||'0',10)).reduce((a,b)=>a+b,0)/ready.length):0;
  const ttrDays = referrals.length? Math.round(referrals.map(r=>{ const o=r.opened_at?new Date(r.opened_at).getTime():null; const a=r.accepted_at?new Date(r.accepted_at).getTime():null; return (o&&a)? Math.max(0,Math.ceil((a-o)/86400000)) : 0; }).reduce((a,b)=>a+b,0)/referrals.length):0;

  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>ุณุฌู ุงููุคุดุฑุงุช (KPI) + ุฑุณูู ุจูุงููุฉ</h2><button class="ghost" id="dl">ุชูุฒูู JSON</button></div>
    <table><thead><tr><th>ุงููุคุดุฑ</th><th>ุงููุงูู</th><th>ุงูุตูุบุฉ</th><th>ุงููุชุฑุฉ</th><th>ุงููุตุฏุฑ</th></tr></thead>
      <tbody>${KPI_REGISTRY.map(k=>`<tr><td><b>${k.name}</b><div class='note'>${k.id}</div></td><td>${k.owner}</td><td>${k.formula}</td><td>${k.period}</td><td>${k.source}</td></tr>`).join('')}</tbody>
    </table>
  </div>
  <div class="card">
    <div class="toolbar"><h3>ููุญุฉ ุณุฑูุนุฉ ูู ุจูุงูุงุชูู</h3><span class="tag">ุชุชุญุฏุซ ุญุณุจ ุงูุฅุฏุฎุงู</span></div>
    <div class="grid three">
      <div class="kpi"><div>ุชุบุทูุฉ ุงููุญุต</div><b>${coverage}%</b></div>
      <div class="kpi"><div>ูุชูุณุท ุงูุฌุงูุฒูุฉ</div><b>${readiness}%</b></div>
      <div class="kpi"><div>TTR ุงูุฅุญุงูุฉ</div><b>${ttrDays} ููู</b></div>
    </div>
    <canvas id="chart1"></canvas>
  </div>`;
  $('#dl').onclick=()=>downloadJSON('kpi_registry.json',KPI_REGISTRY);

  // ุฌููุฒ ุจูุงูุงุช ููุฑุณู: ุนุฏุฏ ุงูุฅุญุงูุงุช ุญุณุจ ุงูุฌูุฉ ูุชุฌุงูุฒ SLA
  const byOwner = {};
  referrals.forEach(r=>{ const own=r._entity||'ุฌูุฉ ุบูุฑ ูุญุฏุฏุฉ'; byOwner[own]=(byOwner[own]||0)+1; });
  const labels=Object.keys(byOwner); const values=Object.values(byOwner);
  const cvs=$('#chart1');
  // ูู ูู ููู ููุงู ุจูุงูุงุชุ ุฃุนุทู ูุซุงููุง ุจุณูุทูุง
  drawBarChart(cvs, labels.length?labels:['ุงูุตุญุฉ','ุงูุชุนููู','ุงููุฑุงูุฒ','ุงูุฌูุนูุงุช'], values.length?values:[2,1,3,1]);
}

/* === ุตูุญุฉ ุญุณุงุจ ุนุงู (ูู ุงูุชุจููุจุงุช + CRUD + RBAC ุญููู + ุฅุดุนุงุฑุงุช) === */
function accountPage(key){
  const A=ACCOUNTS[key]; const v=$('#view'); const tabs=Object.keys(A.tabs);
  v.innerHTML = `<div class="card">
    <div class="toolbar"><h2>${A.title}</h2><span class="tag">ูู ุงูุชุจููุจุงุช ููุนููุฉ</span></div>
    <div class="tabs">${tabs.map((t,i)=>`<button class="tab ${i===0?'active':''}" data-tab="${t}">${t}</button>`).join('')}</div>
    <div id="tabpanel" class="tabpanel"></div>
  </div>`;
  const renderTab=(name)=>{
    const schema=A.tabs[name]; const panel=$('#tabpanel'); panel.innerHTML='';
    panel.innerHTML = `<div class="grid two">
      <div id="formCard" class="card">
        <div class="toolbar"><h3>${name}</h3><span class="tag">ูููุฐุฌ ุงูุฅุฏุฎุงู</span></div>
        <div id="formHost"></div>
        <div class="tools">
          <button class="btn" id="saveRec">ุญูุธ</button>
          <button class="ghost" id="reset">ุชูุฑูุบ</button>
          ${name==='ุงูููุงุนูุฏ'?'<button class="ghost" id="smartAssign">ุชูุฒูุน ุฐูู</button>':''}
          ${name==='ุงูุฅุญุงูุงุช'?'<button class="ghost" id="rf_send">ุฅุฑุณุงู ุฅุญุงูุฉ</button><button class="ghost" id="rf_accept">ูุจูู</button><button class="ghost" id="rf_reject">ุฑูุถ</button>':''}
        </div>
        ${name==='ุงูุฅุญุงูุงุช'?'<div class="callout" id="slaNote">โ</div>':''}
      </div>
      <div id="tableCard" class="card">
        <div class="toolbar"><h3>ุงูุณุฌูุงุช</h3><span class="tag">CRUD + ุจุญุซ + ุงุณุชูุฑุงุฏ/ุชุตุฏูุฑ</span></div>
        <div id="tableHost"></div>
      </div>
    </div>`;
    let editId=null;
    buildForm($('#formHost'), schema);
    const refresh=()=>{ const rows=API.list(key,name).map(r=>({...r,_entity:key})); buildTable($('#tableHost'), schema, rows,{
      onEdit:({id,import:arr})=>{
        if(arr){ API.import(key,name,arr); refresh(); return; }
        const rec=rows.find(r=>r.id===id); editId=id; buildForm($('#formHost'),schema,rec);
      },
      onDelete:({id})=>{ API.remove(key,name,id); refresh(); }
    }); };
    refresh();

    const readForm=()=>Object.fromEntries(schema.map(f=>[f.key, $('#formHost [data-key="'+f.key+'"]')?.value??'']));
    const clearForm=()=>buildForm($('#formHost'),schema);
    $('#saveRec').onclick=()=>{ const data=readForm(); if(editId){ API.update(key,name,editId,data); editId=null; } else { API.create(key,name,data); } refresh(); clearForm(); pushNotif({title:'ุชู ุงูุญูุธ', body:`ุณุฌู ุฌุฏูุฏ ูู ยซ${key} / ${name}ยป`}); };
    $('#reset').onclick=()=>{ editId=null; clearForm(); };

    // ุชูุฒูุน ุฐูู
    if(name==='ุงูููุงุนูุฏ' && $('#smartAssign')){
      $('#smartAssign').onclick=()=>{
        const region=$('#formHost [data-key="region"]')?.value||'ุงูุฑูุงุถ';
        const need=$('#formHost [data-key="need"]')?.value||$('#formHost [data-key="service"]')?.value||'ููุงุฆู';
        const role=loadRole();
        if(!can(role,'appointment.manage')){ alert('โ ูุง ุชููู ุตูุงุญูุฉ ุงูุญุฌุฒ'); return; }
        const c=pickCenter({region,need,maxSlaDays:14});
        if(!c){ alert('ูุง ููุฌุฏ ูุฑูุฒ ููุงุณุจ'); return; }
        if(occPct(c)<100){ c.bookedToday+=1; alert(`โ ุญุฌุฒ ูู ${c.name} โ ุฅุดุบุงู ${occPct(c)}%`); pushNotif({title:'ุญุฌุฒ ูุงุฌุญ',body:`ุชู ุงูุญุฌุฒ ูู ${c.name}`}); }
        else { alert(`โ ุงูุชูุงุก ุงูููู โ ุงูุชุธุงุฑ ${c.name} (โ ${estWaitDays(c)} ููู)`); pushNotif({title:'ูุงุฆูุฉ ุงูุชุธุงุฑ',body:`ุชูุช ุฅุถุงูุฉ ุงููุฑุงุฌุน ูุงูุชุธุงุฑ ${c.name}`}); }
      };
    }

    // ุฅุญุงูุงุช + SLA + ุฅุดุนุงุฑุงุช
    if(name==='ุงูุฅุญุงูุงุช'){
      const updateSLA=()=>{
        const opened=$('#formHost [data-key="opened_at"]')?.value;
        const sla=parseInt($('#formHost [data-key="sla"]')?.value||7,10);
        if(!opened){ $('#slaNote').textContent='โ'; return; }
        const days=Math.ceil((new Date().getTime()-new Date(opened).getTime())/86400000);
        $('#slaNote').textContent = days>sla? `โ ุชุฌุงูุฒ SLA (${days}/${sla} ููู)`:`โ ุถูู SLA (${days}/${sla} ููู)`;
      };
      $('#formHost').addEventListener('input', e=>{ if(e.target.matches('[data-key="opened_at"],[data-key="sla"]')) updateSLA(); });
      updateSLA();
      $('#rf_send').onclick=()=>{ const role=loadRole(); if(!can(role,'referral.send')){ alert('โ ุตูุงุญูุฉ ููููุฏุฉ'); return; } pushNotif({title:'ุฅุฑุณุงู ุฅุญุงูุฉ',body:`ุชู ุฅุฑุณุงู ุฅุญุงูุฉ ูู ยซ${key}ยป`}); alert('โ ุชู ุฅุฑุณุงู ุงูุฅุญุงูุฉ (ูุญุงูุงุฉ)'); };
      $('#rf_accept').onclick=()=>{ const role=loadRole(); if(!can(role,'referral.accept')){ alert('โ ุตูุงุญูุฉ ููููุฏุฉ'); return; } $('#formHost [data-key="accepted_at"]')?.value||(function(){ const acc=document.createElement('input'); acc.type='hidden'; acc.setAttribute('data-key','accepted_at'); acc.value=today(); $('#formHost').appendChild(acc); })(); pushNotif({title:'ูุจูู ุฅุญุงูุฉ',body:`ุชู ูุจูู ุงูุฅุญุงูุฉ ูู ยซ${key}ยป`}); alert('โ ุชู ูุจูู ุงูุฅุญุงูุฉ (ูุญุงูุงุฉ)'); };
      $('#rf_reject').onclick=()=>{ pushNotif({title:'ุฑูุถ ุฅุญุงูุฉ',body:`ุชู ุฑูุถ ุงูุฅุญุงูุฉ ูู ยซ${key}ยป`,type:'warn'}); alert('ุชู ุฑูุถ ุงูุฅุญุงูุฉ (ูุญุงูุงุฉ)'); };
    }
  };
  renderTab(tabs[0]);
  $$('.tab',v).forEach(b=>b.onclick=(e)=>{ $$('.tab',v).forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active'); renderTab(e.currentTarget.dataset.tab); });
}

/* === ููุฒุน ุงูููุงุนูุฏ === */
function dispatchPage(){
  ensure('dispatch','queue'); const v=$('#view');
  v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>ุงูููุฒูุน ุงูุฐูู ููููุงุนูุฏ</h2><span class="tag">ุงุฎุชูุงุฑ ูุฑูุฒ ุญุณุจ ุงูุฅุดุบุงู/SLA/ุงูููุทูุฉ</span></div>
    <div class="grid two form">
      <label>ูููุฉ ุงูุทูู<input id="childId" placeholder="Child-XXXX"/></label>
      <label>ุงูููุทูุฉ<select id="region"><option>ุงูุฑูุงุถ</option><option>ุงูุดุฑููุฉ</option></select></label>
      <label>ุงูุญุงุฌุฉ<select id="need"><option>ููุงุฆู</option><option>ุชุฎุงุทุจ</option><option>ูุธููู</option><option>ูุฑุฒ ุฃููู</option></select></label>
      <label>ุงูุฃููููุฉ<select id="priority"><option>ุนุงุฏูุฉ</option><option>ุนุงุฌูุฉ</option></select></label>
      <label>SLA ุงูุฃูุตู<input id="sla" type="number" value="14"/></label>
    </div>
    <div class="tools"><button class="btn" id="go">ุชูุฒูุน</button><button class="ghost" id="export">ุชุตุฏูุฑ CSV</button></div>
    <pre id="out" class="callout" style="white-space:pre-wrap"></pre>
  </div>
  <div class="card"><div class="toolbar"><h3>ุงูุทูุจุงุช</h3><span class="tag">ูุงุฆูุฉ</span></div><div id="qList"></div></div>`;
  const render=()=>{ const rows=API.list('dispatch','queue'); buildTable($('#qList'),[{key:'childId'},{key:'region'},{key:'need'},{key:'priority'},{key:'centerId'},{key:'centerName'},{key:'status'}],rows,{
    onEdit:()=>{}, onDelete:({id})=>{ API.remove('dispatch','queue',id); render(); }
  }); };
  render();
  $('#go').onclick=()=>{
    const role=loadRole(); if(!can(role,'appointment.manage')){ $('#out').textContent='โ ููุณ ูุฏูู ุตูุงุญูุฉ ุงูุญุฌุฒ'; return; }
    const req={ id:uid('REQ'), childId:$('#childId').value||'Child-โ', region:$('#region').value, need:$('#need').value, priority:$('#priority').value, status:'ุฌุฏูุฏ' };
    const target=pickCenter({region:req.region,need:req.need,maxSlaDays:parseInt($('#sla').value||'14',10)});
    if(target){
      if(occPct(target)<100){ target.bookedToday+=1; req.centerId=target.id; req.centerName=target.name; req.status='ูุญุฌูุฒ ุงูููู'; $('#out').textContent=`โ ุญูุฌุฒ ูู ${target.name} โ ุฅุดุบุงู ${occPct(target)}%`; pushNotif({title:'ุญุฌุฒ ููููู',body:`${req.childId} โ ${target.name}`}); }
      else{ req.centerId=target.id; req.centerName=target.name; req.status='ุงูุชุธุงุฑ ุจุงููุฑูุฒ'; $('#out').textContent=`โ ุงูุชุธุงุฑ ูู ${target.name} (โ ${estWaitDays(target)} ููู)`; pushNotif({title:'ูุงุฆูุฉ ุงูุชุธุงุฑ',body:`${req.childId} ูู ุงูุชุธุงุฑ ${target.name}`}); }
    } else { req.status='ุงูุชุธุงุฑ ุนุงู'; $('#out').textContent='โ๏ธ ูุง ููุฌุฏ ูุฑูุฒ ููุงุณุจ โ ุฃูุถูู ููุงูุชุธุงุฑ ุงูุนุงู'; pushNotif({title:'ูุง ููุฌุฏ ูุฑูุฒ ููุงุณุจ',body:`ุชูุช ุฅุถุงูุฉ ${req.childId} ููุงูุชุธุงุฑ ุงูุนุงู`,type:'warn'}); }
    API.create('dispatch','queue',req); render();
  };
  $('#export').onclick=()=>{
    const rows=API.list('dispatch','queue'); const cols=['id','childId','region','need','priority','centerId','centerName','status','createdAt'];
    downloadCSV('dispatch_queue.csv',[cols,...rows.map(r=>cols.map(c=>r[c]??''))]);
  };
}

/* === ููุญุฉ ุงููุฑุงูุฒ === */
function opsPage(){
  const v=$('#view');
  const cards=CENTERS.map(c=>`<div class="card">
    <div class="toolbar"><h3>${c.name}</h3><span class="tag">${c.type}</span></div>
    <div class="grid two">
      <div class="kpi"><div>ุงูุฅุดุบุงู</div><b>${occPct(c)}%</b><span class="note">ุณุนุฉ ${c.capacityDay}/ููู</span></div>
      <div class="kpi"><div>ุงูุชุธุงุฑ ุชูุฏูุฑู</div><b>${estWaitDays(c)} ููู</b><span class="note">SLA: ${c.slaDays} ุฃูุงู</span></div>
    </div>
    <div class="note">ุชุฎุตุตุงุช: ${c.specialty.join('ุ ')} โข ุงูููุทูุฉ: ${c.region}</div>
  </div>`).join('');
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>ููุญุฉ ุชุดุบูู ุงููุฑุงูุฒ</h2><span class="tag">ุชุดุบูู</span></div><div class="grid two">${cards}</div></div>
  <div class="card danger"><b>ุชูุตูุฉ:</b> ูููุฐุฌ ูุฌูู: ุงููุฑุงูุฒ ุงูุตุญูุฉ ููุชุฏุฎู ุงููุชุฎุตุตุ ููุฑุงูุฒ ุงูุฃุญูุงุก ูููุฑุฒ/ุงูุจุฑุงูุฌ ุงููุฌุชูุนูุฉ ุจุฅุดุฑุงู ููู ูุชุฎููู ุถุบุท ุงูุชูุธูู.</div>`;
}

/* === ุงูุฑุนุงุฉ + ุงูุฃุณุนุงุฑ === */
function sponsorsPage(){
  const v=$('#view'); v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>ุจูุงุจุฉ ุงูุฑุนุงุฉ</h2><span class="tag">ุงุชูุงููุฉ ูุงุจูุฉ ููุทุจุงุนุฉ</span></div>
    <div class="three grid">
      <div class='card'><h3>ูุงุณู</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>1,500,000 ุฑ.ุณ/ุณูุฉ</div><ul><li>ุงูุดุนุงุฑ ูู ูู ุงูุตูุญุงุช</li><li>ุชูุฑูุฑ ุฃุซุฑ ุฑุจุน ุณููู</li><li>ุฃููููุฉ ุชุณููุฉ</li><li>ููุนุฏ ูุฌูุณ ุงูุฑุนุงุฉ</li></ul></div>
      <div class='card'><h3>ุฐูุจู</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>700,000 ุฑ.ุณ/ุณูุฉ</div><ul><li>ุงูุดุนุงุฑ ุจุงูุตูุญุงุช ุงูุฑุฆูุณูุฉ</li><li>ุชูุงุฑูุฑ ูุตู ุณูููุฉ</li><li>ุฏุนูุงุช ูุนุงููุงุช</li></ul></div>
      <div class='card'><h3>ูุถู</h3><div style='font-size:20px;font-weight:800;color:#0f766e'>300,000 ุฑ.ุณ/ุณูุฉ</div><ul><li>ุงูุดุนุงุฑ ุจุตูุญุฉ ุงูุฑุนุงุฉ</li><li>ุดุงุฑุฉ ุงูุชูุงุฑูุฑ</li></ul></div>
    </div>
    <h3>ุทูุจ ุฑุนุงูุฉ</h3>
    <div class="grid two form">
      <label>ุงุณู ุงูุฌูุฉ<input id="sp_org"/></label>
      <label>ุณ.ุช/ุฑูู ุถุฑูุจู<input id="sp_cr"/></label>
      <label>ุงูุจุฑูุฏ ุงูุฅููุชุฑููู<input id="sp_mail"/></label>
      <label>ูุฆุฉ ุงูุฑุนุงูุฉ<select id="sp_tier"><option>Diamond</option><option>Gold</option><option>Silver</option></select></label>
      <label>ุงูููุทูุฉ<select id="sp_region"><option>ุนูู ูุณุชูู ุงูููููุฉ</option><option>ุงูุฑูุงุถ</option><option>ุงูุดุฑููุฉ</option></select></label>
      <label>ุงููุฏุฉ (ุฃุดูุฑ)<input id="sp_months" type="number" value="12"/></label>
    </div>
    <button class="btn" id="gen">ุฅูุดุงุก ุงุชูุงููุฉ</button>
    <div class="card" id="agreement" style="display:none;margin-top:12px"></div>
  </div>`;
  $('#gen').onclick=()=>{
    const org=$('#sp_org').value||'____', tier=$('#sp_tier').value, region=$('#sp_region').value, cr=$('#sp_cr').value||'โ', months=parseInt($('#sp_months').value||'12',10);
    const todayStr=new Date().toLocaleDateString('ar-SA');
    const rights=tier==='Diamond'?'ุดุนุงุฑ ุดุงูู + ุชูุงุฑูุฑ ุฑุจุน ุณูููุฉ + ุฃููููุฉ ุชุณููุฉ + ูุฌูุณ ุงูุฑุนุงุฉ':(tier==='Gold'?'ุดุนุงุฑ ุจุงูุตูุญุงุช ุงูุฑุฆูุณูุฉ + ุชูุงุฑูุฑ ูุตู ุณูููุฉ + ุฏุนูุงุช':'ุดุนุงุฑ ุจุตูุญุฉ ุงูุฑุนุงุฉ + ุดุงุฑุฉ ุชูุงุฑูุฑ');
    $('#agreement').style.display='block';
    $('#agreement').innerHTML=`<h3>ุงุชูุงููุฉ ุฑุนุงูุฉ ููุตุฉ ููู</h3>
    <p>ุจุชุงุฑูุฎ <b>${todayStr}</b> ุจูู ููุตุฉ <b>ููู NOMU</b> ูุงูุฌูุฉ <b>${org}</b> (ุณ.ุช/ุถุฑูุจู: ${cr}) ูุฑุงุนู <b>${tier}</b> ูู <b>${region}</b> ููุฏุฉ <b>${months}</b> ุดูุฑูุง.</p>
    <h4>ุงูุญููู ูุงููุฒุงูุง</h4><p>${rights}</p>
    <h4>ุญูุงูุฉ ุงูุจูุงูุงุช</h4><p>ูุง ูุตูู ูุจูุงูุงุช ุดุฎุตูุฉ. ุฃู ูุดุงุฑูุฉ ุจูุงูุงุช ุชุฎุถุน ูู PDPL ูุงุชูุงููุงุช ูุนุงูุฌุฉ ูุณุชููุฉ.</p>
    <button class="ghost" onclick="window.print()">ุทุจุงุนุฉ / PDF</button>`;
  };
}
function pricingPage(){
  const v=$('#view'); v.innerHTML=`<div class="card">
    <div class="toolbar"><h2>ููุงุฆุญ ุฃุณุนุงุฑ ุงูุฑุนุงูุฉ</h2><span class="tag">ูุงุจูุฉ ููุชุนุฏูู</span></div>
    <table><thead><tr><th>ุงููุฆุฉ</th><th>ุงูุณุนุฑ ุงูุณููู (ุฑ.ุณ)</th><th>ุงููุฒุงูุง</th></tr></thead>
      <tbody>
        <tr><td><b>ูุงุณู</b></td><td>1,500,000</td><td>ุดุนุงุฑ ุดุงูู + ุชูุงุฑูุฑ ุฑุจุน ุณูููุฉ + ูุฌูุณ ุงูุฑุนุงุฉ</td></tr>
        <tr><td><b>ุฐูุจู</b></td><td>700,000</td><td>ุดุนุงุฑ ุจุงูุตูุญุงุช ุงูุฑุฆูุณูุฉ + ุชูุงุฑูุฑ ูุตู ุณูููุฉ + ุฏุนูุงุช</td></tr>
        <tr><td><b>ูุถู</b></td><td>300,000</td><td>ุดุนุงุฑ ุจุตูุญุฉ ุงูุฑุนุงุฉ + ุดุงุฑุฉ ุชูุงุฑูุฑ</td></tr>
      </tbody></table>
  </div>`;
}

/* === ุงูุฃูู ูุงูุฑุจุท === */
function ssoPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>SSO ููุงุฐ (ูุญุงูุงุฉ)</h2><span class="tag">OIDC</span></div>
  <p>ISSUER: <code>${cfg.sso.issuer}</code> โข AUTHZ: <code>${cfg.sso.authorize_url}</code> โข TOKEN: <code>${cfg.sso.token_url}</code></p>
  <button class="btn" id="nafath">ุงูุฏุฎูู ุนุจุฑ ููุงุฐ</button>
  <pre id="ssoLog" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>`;
  $('#nafath').onclick=()=>{ const mock='USR-'+Math.random().toString(36).slice(2,8).toUpperCase(); $('#ssoLog').textContent=`โ code โ id_token\nUserID: ${mock}\nRoles: ["${loadRole()}"]`; };
}
function rbacPage(){ const v=$('#view'); const allPerms=Array.from(new Set(Object.values(RBAC.roles).flat()));
  v.innerHTML=`<div class="card"><div class="toolbar"><h2>RBAC</h2><span class="tag">ุชุนุฑูู ูุชูููู</span></div>
  <div class="grid two">
    <div><h3>ุงูุฃุฏูุงุฑ</h3>${Object.entries(RBAC.roles).map(([r,ps])=>`<div class='note'><b>${r}</b>: ${ps.join(', ')}</div>`).join('')}
    <div class="form" style="margin-top:10px"><label>ุฏูุฑ ุฌุฏูุฏ<input id="newRole"/></label><label>ุงูุชูุงุฒุงุช (ุจููุงุตู)<input id="newPerms"/></label><button class="btn" id="addRole">ุญูุธ</button></div></div>
    <div><h3>ุชูููู</h3><div class="form">
      <label>ุงูุฏูุฑ<select id="roleSel">${Object.keys(RBAC.roles).map(r=>`<option>${r}</option>`).join('')}</select></label>
      <label>ุงูุงูุชูุงุฒ<select id="permSel">${allPerms.map(p=>`<option>${p}</option>`).join('')}</select></label>
      <label>ููุงููุฉ PDPLุ<select id="consSel"><option value="true">ูุนู</option><option value="false">ูุง</option></select></label></div>
      <button class="btn" id="eval">ุชูููู</button>
      <pre id="rbacOut" class="callout" style="white-space:pre-wrap;margin-top:10px"></pre></div>
  </div></div>`;
  $('#addRole').onclick=()=>{ const r=$('#newRole').value.trim(); const perms=$('#newPerms').value.split(',').map(x=>x.trim()).filter(Boolean); if(!r||!perms.length) return alert('ุฃุฏุฎู ุงูููู'); RBAC.roles[r]=perms; pushNotif({title:'ุฏูุฑ ุฌุฏูุฏ',body:`ุชูุช ุฅุถุงูุฉ ุงูุฏูุฑ ${r}`}); route(); };
  $('#eval').onclick=()=>{ const role=$('#roleSel').value, perm=$('#permSel').value, consent=$('#consSel').value==='true'; $('#rbacOut').textContent=(can(role,perm,consent)?'โ ูุณููุญ':'โ ูุฑููุถ')+`\nุงูุฏูุฑ: ${role}\nุงูุงูุชูุงุฒ: ${perm}\nุงูููุงููุฉ: ${consent}`; };
}
function configPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>ุงูุฅุนุฏุงุฏุงุช</h2><span class="tag">Endpoints</span></div>
  <div class="grid two form">
    <label>SSO Issuer<input id="issuer" value="${cfg.sso.issuer}"/></label>
    <label>Authorize URL<input id="authz" value="${cfg.sso.authorize_url}"/></label>
    <label>Token URL<input id="token" value="${cfg.sso.token_url}"/></label>
    <label>Client ID<input id="cid" value="${cfg.sso.client_id}"/></label>
    <label>Redirect URI<input id="redir" value="${cfg.sso.redirect_uri}"/></label>
  </div>
  <h3>ูุณุงุฑุงุช ุฏุงุฎููุฉ</h3>
  <div class="grid two form">
    ${Object.entries(cfg.apis.internal).map(([k,v2])=>`<label>${k}<input data-int="${k}" value="${v2}"/></label>`).join('')}
  </div>
  <div class="tools"><button class="btn" id="saveCfg">ุญูุธ</button><button class="ghost" id="dlCfg">ุชูุฒูู config.json</button><button class="ghost" id="resetCfg">ุงุณุชุนุงุฏุฉ ุงูุงูุชุฑุงุถู</button></div>
</div>`;
  $('#saveCfg').onclick=()=>{ const next={ sso:{ issuer:$('#issuer').value, authorize_url:$('#authz').value, token_url:$('#token').value, client_id:$('#cid').value, redirect_uri:$('#redir').value }, apis:{ internal:Object.fromEntries($$('[data-int]').map(i=>[i.dataset.int,i.value])) } }; saveCfg(next); pushNotif({title:'ุฅุนุฏุงุฏุงุช',body:'ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช'}); };
  $('#dlCfg').onclick=()=>downloadJSON('config.json', loadCfg());
  $('#resetCfg').onclick=()=>{ localStorage.removeItem('nomu_cfg'); alert('ุชูุช ุงูุงุณุชุนุงุฏุฉ'); route(); };
}

/* === ุณูุงุณุงุช / ูุณุงุนุฏุฉ / ุดุฑูุท === */
function privacyPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>ุณูุงุณุฉ ุงูุฎุตูุตูุฉ (PDPL)</h2><span class="tag">ุชูููุฐูุฉ</span></div>
<ul><li>ููุงููุฉ ููู ุงูุฃูุฑ</li><li>ุชุดููุฑ ุฃุซูุงุก ุงูููู ูุงูุชุฎุฒูู</li><li>RBAC ูุชุณุฌูู ุงูุฃุซุฑ</li><li>ุญููู: ุงูุงุทูุงุน/ุงูุชุตุญูุญ/ุงูุณุญุจ/ุงูุญุฐู</li></ul><button class="ghost" onclick="window.print()">ุทุจุงุนุฉ</button></div>`; }
function childPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>ุญูุงูุฉ ุงูุทูู</h2><span class="tag">ุณูุงูุฉ ุฃูููุง</span></div>
<ol><li>ุชูุซูู ุงููุงูุนุฉ</li><li>ุชูููู ุงููุฎุงุทุฑ</li><li>ุงูุฅุญุงูุฉ ูุงููุชุงุจุนุฉ</li></ol><div class="callout">ููุงุฉ ุงูุฅุจูุงุบ ูุชุงุญุฉ ูููุฎููููู.</div><button class="ghost" onclick="window.print()">ุทุจุงุนุฉ</button></div>`; }
function helpPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>ูุฑูุฒ ุงููุณุงุนุฏุฉ</h2><span class="tag">FAQ</span></div>
<details open><summary><b>RBAC ููุญููู</b></summary><p>ุจุนุถ ุงูุญููู ููููุฉ ุฅู ูู ูุญูู ุงูุฏูุฑ ุงูุชูุงุฒูุง (ูุซุงู: <code>health.write</code>).</p></details>
<details><summary><b>ุงูุฅุดุนุงุฑุงุช</b></summary><p>ููุธูุฑ ุงูุฌุฑุณ ุฌููุน ุงูุฃุญุฏุงุซ ูุงูุชูุจููุงุช (ุชุฌุงูุฒ SLA/ุญุฌุฒ/ุญูุธ...)</p></details></div>`; }
function termsPage(){ const v=$('#view'); v.innerHTML=`<div class="card"><div class="toolbar"><h2>ุงูุดุฑูุท ูุงูุฃุญูุงู</h2><span class="tag">ุงุณุชุฎุฏุงู</span></div>
<ul><li>ุงูุงูุชุฒุงู ุจุงูุณูุงุณุงุช ุงููุทููุฉ ูPDPL.</li><li>ุญุธุฑ ูุดุงุฑูุฉ ุงูุจูุงูุงุช ุฎุงุฑุฌ ุงูููุธููุฉ.</li><li>ุงูุชูุงูู ุนุจุฑ ุงููููุงุช ุงูุฑุณููุฉ.</li></ul><button class="ghost" onclick="window.print()">ุทุจุงุนุฉ</button></div>`; }

/* === API Docs / Export === */
function apiDocsPage(){ const v=$('#view'); const cfg=loadCfg(); v.innerHTML=`<div class="card">
  <div class="toolbar"><h2>API Docs (ูุญุงูุงุฉ)</h2><span class="tag">Endpoints</span></div>
  <table><thead><tr><th>ุงูููุงู</th><th>Endpoint</th></tr></thead><tbody>${Object.entries(cfg.apis.internal).map(([k,val])=>`<tr><td>${k}</td><td><code>${val}</code></td></tr>`).join('')}</tbody></table>
  <h3>POST /api/health/referral</h3><pre class="callout">{ "mrn":"...", "ref_to":"education", "priority":"high", "attachments":["url1"] }</pre>
</div>`; }
function exportPage(){ const v=$('#view'); const db=DB(); v.innerHTML=`<div class="card"><div class="toolbar"><h2>ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช</h2><span class="tag">LocalStorage</span></div>
<div class="tools"><button class="btn" id="dlDb">ุชูุฒูู JSON ูุงูู</button><label class="ghost" style="padding:6px 10px;border-radius:10px;cursor:pointer">ุงุณุชูุฑุงุฏ JSON<input id="upDb" type="file" accept="application/json" style="display:none"/></label><button class="ghost" id="wipe">ุชูุฑูุบ ูุงูู</button></div>
<pre class="note">ุงูููุชุงุญ: ${DB_KEY} โข ุงูุญุฌู ุงูุญุงูู: ${new Blob([JSON.stringify(db)]).size} ุจุงูุช</pre></div>`;
  $('#dlDb').onclick=()=>downloadJSON('nomu_db_backup.json', DB());
  $('#upDb').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const obj=JSON.parse(fr.result||'{}'); DB_SAVE(obj); pushNotif({title:'ุงุณุชูุฑุงุฏ',body:'ุชู ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช'}); }catch(err){ alert('JSON ุบูุฑ ุตุงูุญ'); } }; fr.readAsText(f); };
  $('#wipe').onclick=()=>{ if(confirm('ุณููุณุญ ูู ุงูุจูุงูุงุช ุงููุญููุฉ')){ DB_SAVE({}); pushNotif({title:'ุชูุฑูุบ',body:'ุชู ุชูุฑูุบ ูุงุนุฏุฉ ุงูุจูุงูุงุช'}); } };
}

/* ===== Router ===== */
const routes={
  '/intro':intro,'/kpi':kpiPage,
  '/acc/health':()=>accountPage('health'),'/acc/clinic':()=>accountPage('clinic'),'/acc/education':()=>accountPage('education'),
  '/acc/neighborhood':()=>accountPage('neighborhood'),'/acc/nonprofit':()=>accountPage('nonprofit'),'/acc/hr':()=>accountPage('hr'),
  '/acc/csr':()=>accountPage('csr'),'/acc/family':()=>accountPage('family'),'/acc/admin':()=>accountPage('admin'),
  '/dispatch':dispatchPage,'/ops':opsPage,
  '/sponsors':sponsorsPage,'/pricing':pricingPage,
  '/sso':ssoPage,'/rbac':rbacPage,'/config':configPage,
  '/privacy':privacyPage,'/child':childPage,'/help':helpPage,'/terms':termsPage,
  '/export':exportPage,'/apidocs':apiDocsPage
};
if(!location.hash) location.hash='#/intro';
route();
</script>

<script>
(function(){
  const DEFAULT_USERNAME="NOMU", DEFAULT_PASSWORD="1234", AUTH_KEY="nomu_auth_v1";
  const isMobile = ()=> window.matchMedia && matchMedia("(max-width:979px)").matches;
  const save=(u,p)=>localStorage.setItem(AUTH_KEY, JSON.stringify({u,p,t:Date.now()}));

  function mountMobileLoginDropdown(){
    if (!isMobile()) return;
    if (document.getElementById("mobileLoginMenu")) return;
    const host = document.getElementById("mobileLoginBtn");
    if (!host) return;
    const menu = document.createElement("div");
    menu.id = "mobileLoginMenu";
    menu.style.position="absolute"; menu.style.top="56px"; menu.style.insetInlineEnd="12px";
    menu.style.background="#fff"; menu.style.border="1px solid var(--border)";
    menu.style.borderRadius="12px"; menu.style.padding="10px"; menu.style.zIndex=9999;
    menu.style.boxShadow="0 12px 30px rgba(2,12,27,.15)"; menu.style.width="min(92vw, 420px)";
    const accounts=[
      {k:"#/acc/health",t:"ูุฒุงุฑุฉ ุงูุตุญุฉ"},
      {k:"#/acc/clinic",t:"ุงููุฑุงูุฒ ุงูุตุญูุฉ"},
      {k:"#/acc/education",t:"ูุฒุงุฑุฉ ุงูุชุนููู"},
      {k:"#/acc/neighborhood",t:"ูุฑุงูุฒ ุงูุฃุญูุงุก"},
      {k:"#/acc/nonprofit",t:"ุงูุฌูุนูุงุช"},
      {k:"#/acc/hr",t:"ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ"},
      {k:"#/acc/csr",t:"ุงููุทุงุน ุงูุฎุงุต"},
      {k:"#/acc/family",t:"ุงูุฃุณุฑุฉ"},
      {k:"#/acc/admin",t:"ุงููุฌูุฉ ุงููุทููุฉ"},
    ];
    let html = `<div style="font-size:13px;color:#334155;margin-bottom:8px">ุงุฎุชุฑ ููุน ุงูุญุณุงุจุ ูุณูุชู ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุนุฑุถ ุชููุงุฆููุง (NOMU / 1234)</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px">`;
    accounts.forEach(a=>{ html += `<button class="btn" data-go="${a.k}" style="padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff">${a.t}</button>`; });
    html += `</div>`;
    menu.innerHTML = html;
    document.body.appendChild(menu);
    menu.querySelectorAll("button[data-go]").forEach(b=> b.onclick = ()=>{
      save(DEFAULT_USERNAME, DEFAULT_PASSWORD);
      location.hash = b.getAttribute("data-go");
      menu.remove();
    });
    setTimeout(()=>{
      function off(e){
        if (!menu.contains(e.target) && e.target.id !== "mobileLoginBtn"){ menu.remove(); document.removeEventListener("click", off); }
      }
      document.addEventListener("click", off);
    },0);
  }

  window.addEventListener("load", ()=>{
    const btn = document.getElementById("mobileLoginBtn");
    if (btn){
      btn.addEventListener("click", (e)=>{ e.preventDefault(); mountMobileLoginDropdown(); });
    }
  });

  // ุนูุฏ ุงูุถุบุท ุนูู ุฑูุงุจุท ุงูุญุณุงุจุงุช ูู ุงูุฌูุงูุ ุฅู ูู ููู ูุณุฌูุงู ููุชุญ ูุงุฆูุฉ ุงูุงุฎุชูุงุฑ ุจุฏูุงู ูู ุงูููุน
  try{
    document.querySelectorAll('[data-route^="#/acc/"],a[href^="#/acc/"]').forEach(a=>{
      a.addEventListener("click",(e)=>{
        if (isMobile()){
          e.preventDefault();
          const btn = document.getElementById("mobileLoginBtn");
          if (btn){ btn.scrollIntoView({behavior:"smooth", block:"start"}); }
          mountMobileLoginDropdown();
        }
      });
    });
  }catch(_){}
})();
</script>


<script>
(function(){
  const DEFAULT_USERNAME="NOMU", DEFAULT_PASSWORD="1234", AUTH_KEY="nomu_auth_v1";
  const save=(u,p)=>localStorage.setItem(AUTH_KEY, JSON.stringify({u,p,t:Date.now()}));

  function mountDesktopLoginDropdown(){
    if (document.getElementById("desktopLoginMenu")) return;
    const host = document.getElementById("desktopLoginBtn");
    if (!host) return;
    const menu = document.createElement("div");
    menu.id = "desktopLoginMenu";
    const rect = host.getBoundingClientRect();
    menu.style.position="fixed"; menu.style.top= (rect.bottom + 8) + "px"; menu.style.left = Math.max(12, rect.left - 260) + "px";
    menu.style.background="#fff"; menu.style.border="1px solid var(--border)"; menu.style.borderRadius="12px"; menu.style.padding="10px";
    menu.style.zIndex=9999; menu.style.boxShadow="0 12px 30px rgba(2,12,27,.15)"; menu.style.width="min(520px, 50vw)";
    const accounts=[
      {k:"#/acc/health",t:"ูุฒุงุฑุฉ ุงูุตุญุฉ"},
      {k:"#/acc/clinic",t:"ุงููุฑุงูุฒ ุงูุตุญูุฉ"},
      {k:"#/acc/education",t:"ูุฒุงุฑุฉ ุงูุชุนููู"},
      {k:"#/acc/neighborhood",t:"ูุฑุงูุฒ ุงูุฃุญูุงุก"},
      {k:"#/acc/nonprofit",t:"ุงูุฌูุนูุงุช"},
      {k:"#/acc/hr",t:"ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ"},
      {k:"#/acc/csr",t:"ุงููุทุงุน ุงูุฎุงุต"},
      {k:"#/acc/family",t:"ุงูุฃุณุฑุฉ"},
      {k:"#/acc/admin",t:"ุงููุฌูุฉ ุงููุทููุฉ"},
    ];
    let html = `<div style="font-size:13px;color:#334155;margin-bottom:8px">ุงุฎุชุฑ ููุน ุงูุญุณุงุจ โ ุณูุชู ุชุนุจุฆุฉ ุจูุงูุงุช ุงูุนุฑุถ ุชููุงุฆููุง (NOMU / 1234)</div>`;
    html += `<div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px">`;
    accounts.forEach(a=>{ html += `<button class="btn" data-go="${a.k}" style="padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff">${a.t}</button>`; });
    html += `</div>`;
    menu.innerHTML = html;
    document.body.appendChild(menu);
    menu.querySelectorAll("button[data-go]").forEach(b=> b.onclick = ()=>{
      save("NOMU","1234");
      location.hash = b.getAttribute("data-go");
      menu.remove();
    });
    setTimeout(()=>{
      function off(e){
        if (!menu.contains(e.target) && e.target.id !== "desktopLoginBtn"){ menu.remove(); document.removeEventListener("click", off); }
      }
      document.addEventListener("click", off);
    },0);
  }

  window.addEventListener("load", ()=>{
    const btn = document.getElementById("desktopLoginBtn");
    if (btn){
      btn.addEventListener("click", (e)=>{ e.preventDefault(); mountDesktopLoginDropdown(); });
    }
  });
})();
</script>

</body>
</html>
